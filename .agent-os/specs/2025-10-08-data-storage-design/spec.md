# Spec Requirements Document

> Spec: 数据存储设计
> Created: 2025-10-08

## Overview

设计并实现基于 PostgreSQL + TimescaleDB 和 Redis 的数据存储架构，支持高效存储和查询加密货币交易对的历史价格数据（K线、Tick数据）和实时数据缓存。该设计将支持100+交易对的实时监控，数据保留策略为近一个月，并通过时序数据压缩策略优化存储空间，同时实现读写分离和连接池管理以保证高并发场景下的性能。

## User Stories

### 数据持久化开发者需求

作为后端开发者, 我希望有一套完善的数据访问层（DAO），使得我可以方便地存储和查询交易对的历史价格数据，而不需要直接编写SQL语句。

工作流程：调用 DAO 接口保存从 BitGet API 获取的交易对信息、K线数据和实时 Ticker 数据，系统自动将数据写入对应的数据库表，并通过 TimescaleDB 的时序优化功能提供高效查询。对于实时数据，DAO 还会同步更新 Redis 缓存，确保前端能快速获取最新价格。

### 实时监控服务需求

作为实时数据采集服务, 我希望将最新的价格数据缓存在 Redis 中，使得前端可以在毫秒级延迟内获取实时价格变化，而不需要每次都查询数据库。

工作流程：接收到 WebSocket 推送的实时 Ticker 数据后，立即更新 Redis 中的价格缓存（Hash 结构），同时计算实时指标（如1分钟、5分钟涨跌幅）并缓存结果。异步批量将历史数据写入 TimescaleDB 以减少数据库写入压力。

### 历史数据分析需求

作为策略回测服务, 我希望高效查询特定时间范围内的历史K线数据，使得我可以快速完成策略回测计算，验证交易策略的可行性。

工作流程：通过 DAO 接口查询指定交易对在特定时间范围内的K线数据，TimescaleDB 的时序索引和数据压缩功能确保查询性能，即使查询一个月的分钟级K线数据（约43,000条）也能在1秒内返回结果。数据访问层支持分页查询，避免一次性加载过多数据。

## Spec Scope

1. **PostgreSQL 数据库表设计** - 设计 symbols（交易对信息）、price_ticks（实时价格数据，时序表）、klines（K线数据，时序表）三个核心表，包含完整字段定义、索引、约束和外键关系

2. **TimescaleDB 时序优化配置** - 配置 price_ticks 和 klines 表为 TimescaleDB 超表（Hypertable），设置数据分片策略（按时间分片），配置数据压缩策略（保留近7天原始数据，7天以上压缩），设置数据保留策略（自动删除30天以上数据）

3. **Redis 缓存键值结构设计** - 设计实时价格缓存（Hash）、实时指标缓存（Hash）、交易对列表缓存（Set）、WebSocket 连接管理（Set）的键值结构，定义 TTL 过期策略和缓存更新策略

4. **数据访问层（DAO）实现** - 实现 SymbolDAO、KlineDAO、TickerDAO 三个数据访问对象，封装增删改查操作，支持批量插入、分页查询、时间范围查询等常用功能

5. **读写分离和连接池配置** - 配置 PostgreSQL 主从读写分离（主库写入，从库查询），实现连接池管理（最大连接数、空闲连接数、连接超时），配置 Redis 连接池，优化高并发场景下的数据库性能

## Out of Scope

- 数据库备份和恢复策略（将在后续运维规范中定义）
- 分布式数据库架构（初期单机部署即可满足需求）
- 用户策略配置表和回测结果表（属于 Phase 2 功能）
- 数据同步和迁移工具（当前不需要从其他系统迁移数据）
- 实时数据流处理框架（如 Kafka，当前使用 Go 协程处理即可）

## Expected Deliverable

1. 可以成功创建 PostgreSQL 数据库，包含 symbols、price_ticks、klines 三个表，并配置 TimescaleDB 扩展，表结构符合 BitGet API 字段定义

2. 可以通过 DAO 接口成功保存和查询交易对信息、K线数据和 Ticker 数据，数据写入后能正确存储到数据库，查询结果与写入数据一致

3. 可以验证 TimescaleDB 数据压缩和保留策略生效，7天以上的数据自动压缩，30天以上的数据自动删除

4. 可以通过 Redis 客户端成功读写实时价格缓存，缓存数据与数据库数据一致，TTL 过期策略正常工作

5. 可以验证读写分离配置生效，写操作路由到主库，读操作路由到从库，连接池在高并发场景下（100+并发查询）表现稳定
