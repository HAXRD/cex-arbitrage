# Spec Requirements Document

> Spec: 数据存储设计
> Created: 2025-10-08

## Overview

设计并实现完整的数据存储架构，包括PostgreSQL时序数据库表结构、TimescaleDB优化配置、Redis缓存策略和数据访问层（DAO），以支持实时价格监控、历史数据查询和策略回测功能。该设计将确保系统能够高效存储和查询上百个交易对的实时和历史价格数据，同时通过Redis缓存提升实时数据访问性能。

## User Stories

### 数据采集开发者

作为后端开发者，我希望有清晰的数据库表结构和DAO接口，以便能够快速实现数据采集服务，将BitGet API获取的实时价格数据和K线数据持久化存储到PostgreSQL，并通过Redis缓存提供实时访问。

工作流程：调用BitGet API获取数据 → 使用DAO层接口写入数据库 → 同步更新Redis缓存 → 记录操作日志。系统需要支持高频写入（每秒数百条价格更新），同时保证数据一致性。

### 前端开发者

作为前端开发者，我希望通过统一的API接口查询实时价格和历史数据，而无需关心底层数据存储细节。API应该能够快速返回最新价格（从Redis）、历史K线数据（从PostgreSQL）和交易对配置信息。

工作流程：调用REST API获取数据 → 接收标准化的JSON响应 → 在前端展示价格图表和监控面板。查询响应时间应在100ms以内。

### 系统运维人员

作为运维人员，我希望数据库有合理的索引、分区和数据保留策略，确保系统长期稳定运行，数据库不会因历史数据堆积而性能下降，同时关键数据能够安全备份和恢复。

工作流程：监控数据库性能指标 → 执行定期数据清理和压缩 → 管理数据备份 → 优化慢查询。数据保留策略为近一个月，超过一个月的数据自动归档或删除。

## Spec Scope

1. **PostgreSQL表结构设计** - 设计symbols（交易对）、price_ticks（实时价格）、klines（K线数据）等核心表，包括字段定义、数据类型、索引和约束

2. **TimescaleDB时序优化** - 配置price_ticks和klines为TimescaleDB超表（hypertable），设置时间分区、数据压缩策略和数据保留策略（近一个月）

3. **Redis缓存设计** - 设计Redis键值结构，存储实时价格、24h涨跌幅、交易量等实时指标，支持快速查询和实时计算

4. **数据访问层（DAO）实现** - 实现Go语言DAO层，封装数据库操作（CRUD），支持连接池、读写分离、事务管理和错误处理

5. **数据库迁移脚本** - 编写SQL迁移脚本，支持数据库初始化、表创建、索引创建和TimescaleDB配置

## Out of Scope

- 用户认证和权限管理表（后续Phase中实现）
- 回测结果存储表（Phase 2实现）
- 策略配置表（Phase 2实现）
- 数据库读写分离的具体部署架构（本规范只设计代码层面支持，实际部署在生产环境阶段配置）
- 高可用和灾备方案（生产环境阶段实现）

## Expected Deliverable

1. 可以通过SQL迁移脚本成功创建所有数据库表（symbols、price_ticks、klines），并配置TimescaleDB超表、索引和数据保留策略

2. 可以通过DAO接口成功插入和查询交易对数据、实时价格数据和K线数据，写入性能支持每秒500+条记录

3. 可以在Redis中成功存储和查询实时价格数据，查询响应时间小于10ms，支持实时指标计算（如价格变化率）

4. 数据库查询性能满足要求：查询最新100条价格记录耗时小于50ms，查询指定交易对最近24小时K线数据耗时小于100ms

5. 数据保留策略正常工作：超过一个月的历史数据自动压缩和清理，数据库存储空间保持稳定

